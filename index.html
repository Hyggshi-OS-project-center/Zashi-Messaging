<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Zashi Messaging - Auth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .msg-animate {
      animation: msgFadeInUp 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }
    @keyframes msgFadeInUp {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.98);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .theme-transition {
      transition: background-color 0.4s, color 0.4s;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 theme-transition">
  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full max-w-md space-y-4 relative">
      <h1 id="mainTitle" class="text-2xl font-bold text-center mb-2">Zashi Messaging</h1>
      <!-- Auth Box -->
      <div id="authBox" class="space-y-3">
        <input id="username" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="Username" />
        <input id="email" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="Gmail" />
        <input id="password" type="password" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="Password" />
        <button id="registerBtn" onclick="register()" class="w-full bg-purple-500 text-white py-2 rounded">ƒêƒÉng k√Ω</button>
        <button id="loginBtn" onclick="login()" class="w-full bg-green-500 text-white py-2 rounded">ƒêƒÉng nh·∫≠p</button>
        <button id="forgotBtn" onclick="showResetPassword()" class="w-full bg-gray-400 text-white py-2 rounded">Qu√™n m·∫≠t kh·∫©u?</button>
      </div>
      <!-- Reset Password Box -->
      <div id="resetBox" class="space-y-3 hidden">
        <h2 id="resetTitle" class="text-xl font-bold text-center">Qu√™n m·∫≠t kh·∫©u</h2>
        <input id="resetUsername" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="Username" />
        <input id="resetPassword" type="password" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="M·∫≠t kh·∫©u m·ªõi" />
        <button id="resetBtn" onclick="resetPassword()" class="w-full bg-blue-500 text-white py-2 rounded">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
        <button id="backToLoginBtn" onclick="hideResetPassword()" class="w-full bg-gray-400 text-white py-2 rounded">Quay l·∫°i</button>
      </div>
    </div>
  </div>
  <!-- Join Group Modal -->
  <div id="joinGroupModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full max-w-md space-y-4 relative">
      <h2 class="text-xl font-bold text-center mb-2">V√†o nh√≥m chat</h2>
      <input id="group" class="w-full px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="T√™n nh√≥m chat" />
      <label for="avatarInput" class="block mb-2">Ch·ªçn ·∫£nh ƒë·∫°i di·ªán (t√πy ch·ªçn):</label>
      <input id="avatarInput" type="file" accept="image/*" class="w-full mb-4" />
      <button id="joinBtn" onclick="join()" class="w-full bg-blue-500 text-white py-2 rounded">V√†o Chat</button>
    </div>
  </div>
  <div id="chatBox" class="hidden">
    <div class="max-w-6xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden p-0 flex flex-row h-[80vh] min-h-[600px]">
      <!-- Sidebar: Danh s√°ch cu·ªôc tr√≤ chuy·ªán -->
      <div id="sidebar" class="w-1/5 min-w-[220px] bg-gray-50 dark:bg-gray-900 border-r dark:border-gray-700 flex flex-col">
        <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
          <span class="font-bold text-lg">Chats</span>
          <button id="newChatBtn" onclick="showJoinGroupModal()" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">+</button>
        </div>
        <div id="chatList" class="flex-1 overflow-y-auto">
          <!-- Danh s√°ch nh√≥m/chat s·∫Ω render ·ªü ƒë√¢y -->
        </div>
        <div class="p-4 border-t dark:border-gray-700 flex items-center justify-between">
          <button id="settingsBtn" onclick="showSettings()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400 w-full">‚öôÔ∏è <span>C√†i ƒë·∫∑t</span></button>
        </div>
      </div>
      <!-- Main Chat Window -->
      <div id="mainChat" class="flex-1 flex flex-col bg-white dark:bg-gray-800">
        <div class="flex items-center justify-between border-b dark:border-gray-700 px-6 py-3">
          <div class="flex items-center space-x-3">
            <img id="mainChatAvatar" src="" alt="avatar" class="w-10 h-10 rounded-full hidden">
            <span id="mainChatTitle" class="font-bold text-lg">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</span>
          </div>
          <button id="logoutBtn" onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">ƒêƒÉng xu·∫•t</button>
        </div>
        <div id="chat" class="flex-1 overflow-y-auto p-6"></div>
        <div class="border-t dark:border-gray-700 px-6 py-4 bg-gray-50 dark:bg-gray-900">
          <div class="flex items-center space-x-2">
            <input id="msg" class="flex-1 px-4 py-3 text-lg border rounded-md text-gray-900 dark:text-gray-100" placeholder="Nh·∫≠p tin nh·∫Øn..." />
            <input type="file" id="fileInput" class="hidden" />
            <label id="chooseFileLabel" for="fileInput" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 cursor-pointer text-sm">Ch·ªçn t·ªáp</label>
            <button id="sendBtn" onclick="send()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm flex items-center space-x-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
              </svg>
              <span>G·ª≠i</span>
            </button>
          </div>
          <div id="filePreview" class="mt-2"></div>
        </div>
      </div>
      <!-- Info Panel: Th√¥ng tin chi ti·∫øt -->
      <div id="infoPanel" class="w-1/4 min-w-[260px] bg-gray-50 dark:bg-gray-900 border-l dark:border-gray-700 flex flex-col">
        <div class="p-6 border-b dark:border-gray-700">
          <div class="flex flex-col items-center">
            <img id="infoAvatar" src="" alt="avatar" class="w-20 h-20 rounded-full mb-2">
            <div id="infoName" class="font-bold text-xl mb-1"></div>
            <div id="infoEmail" class="text-sm text-gray-500 mb-2"></div>
            <div id="infoStatus" class="text-xs text-green-500">Online</div>
          </div>
        </div>
        <div id="infoDetails" class="flex-1 p-6 overflow-y-auto">
          <!-- Th√¥ng tin chi ti·∫øt v·ªÅ nh√≥m ho·∫∑c user s·∫Ω render ·ªü ƒë√¢y -->
        </div>
      </div>
    </div>
    <!-- Th√¥ng tin c√° nh√¢n -->
    <div class="flex items-center space-x-3 mt-4">
      <img id="myAvatar" src="" alt="avatar" class="w-10 h-10 rounded-full">
      <span id="myName" class="font-bold"></span>
      <span id="myEmail" class="text-gray-500"></span>
    </div>
    <!-- Reply Box -->
    <div id="replyBox" class="hidden mt-2 bg-blue-100 dark:bg-blue-900 p-2 rounded flex items-center space-x-2">
      <span class="font-semibold">ƒêang tr·∫£ l·ªùi:</span>
      <span id="replyPreview"></span>
      <button onclick="cancelReply()" class="ml-auto bg-gray-400 text-white px-2 py-1 rounded">H·ªßy</button>
    </div>
    <!-- Settings Box (·∫©n m·∫∑c ƒë·ªãnh) -->
    <div id="settingsBox" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full max-w-md space-y-4 relative">
        <h2 id="settingsTitle" class="text-xl font-bold text-center mb-2">C√†i ƒë·∫∑t</h2>
        <label for="displayNameInput">T√™n hi·ªÉn th·ªã m·ªõi:</label>
        <input id="displayNameInput" class="w-full px-4 py-2 border rounded mb-2" placeholder="T√™n hi·ªÉn th·ªã m·ªõi">
        <label for="emailInput">Gmail:</label>
        <input id="emailInput" class="w-full px-4 py-2 border rounded mb-2" placeholder="Gmail">
        <label for="newAvatarInput">ƒê·ªïi avatar:</label>
        <input id="newAvatarInput" type="file" accept="image/*" class="w-full mb-2">
        <label for="themeSelect">Giao di·ªán:</label>
        <select id="themeSelect" class="w-full px-2 py-1 border rounded mb-2">
          <option value="light">S√°ng</option>
          <option value="dark">T·ªëi</option>
        </select>
        <label for="langSwitch">Ng√¥n ng·ªØ:</label>
        <select id="langSwitch" class="w-full px-2 py-1 border rounded mb-2" onchange="switchLanguage(this.value)">
          <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
          <option value="en">üá¨üáß English</option>
          <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
          <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
          <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
          <option value="tl">üáµüá≠ Filipino</option>
          <option value="es">üá≤üáΩ Espa√±ol</option>
          <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="ms">üá∏üá¨ Malay</option>
          <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
        </select>
        <button id="saveSettingsBtn" onclick="saveSettings()" class="w-full bg-green-500 text-white py-2 rounded">L∆∞u thay ƒë·ªïi</button>
        <button id="hideSettingsBtn" onclick="hideSettings()" class="w-full bg-gray-400 text-white py-2 rounded">Quay l·∫°i</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket = null, username = '', password = '', avatarUrl = '', group = '', isConnected = false, replyTo = null, privateChatUser = null;

    document.getElementById('fileInput').addEventListener('change', function() {
      const file = this.files[0];
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';

      if (!file) return;

      const fileName = file.name;
      const fileSize = (file.size / 1024).toFixed(2) + ' KB';

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'w-32 h-32 object-cover rounded';
        preview.appendChild(img);
      }

      const info = document.createElement('p');
      info.className = 'text-sm text-gray-500 mt-1';
      info.textContent = `${fileName} (${fileSize})`;
      preview.appendChild(info);
    });

    async function register() {
      const inputUsername = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const inputPassword = document.getElementById('password').value.trim();
      if (!inputUsername || !inputPassword || !email) {
        showToast('Nh·∫≠p ƒë·ªß username, password v√† email!', 'error');
        return;
      }
      const res = await fetch('http://localhost:3001/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: inputUsername, password: inputPassword, email })
      }).then(r => r.json());
      showToast(res.success ? 'ƒêƒÉng k√Ω th√†nh c√¥ng' : res.message, res.success ? 'success' : 'error');
      if (res.success) {
        document.getElementById('username').value = '';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('joinGroupModal').classList.remove('hidden');
      }
    }

    async function login() {
      const inputUsername = document.getElementById('username').value.trim();
      const inputPassword = document.getElementById('password').value.trim();
      if (!inputUsername || !inputPassword) {
        showToast('Nh·∫≠p ƒë·ªß username v√† password!', 'error');
        return;
      }
      const res = await fetch('http://localhost:3001/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: inputUsername, password: inputPassword })
      }).then(r => r.json());
      if (res.success) {
        username = inputUsername;
        password = inputPassword;
        window.userEmail = res.email || '';
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('joinGroupModal').classList.remove('hidden');
        document.getElementById('myEmail').textContent = window.userEmail;
      } else showToast(res.message, 'error');
    }

    function showJoinGroupModal() {
      document.getElementById('group').value = '';
      document.getElementById('avatarInput').value = null;
      document.getElementById('joinGroupModal').classList.remove('hidden');
    }

    function join() {
      const newGroupName = document.getElementById('group').value.trim();
      if (!newGroupName) {
        showToast(LANGS[currentLang].joinAlert, 'error');
        return;
      }
      
      const avatarFile = document.getElementById('avatarInput').files[0];

      const joinLogic = () => {
        group = newGroupName;

        if (!socket) {
          socket = io('http://localhost:3001');
          isConnected = true;

          socket.on('avatar', (url) => { avatarUrl = url; });
          socket.on('loadMessages', (msgs) => {
            document.getElementById('chat').innerHTML = '';
            msgs.forEach(addMessage);
          });
          socket.on('newMessage', (msgObj) => { addMessage(msgObj); });
          socket.on('newFile', (fileObj) => {
            addMessage({
              user: fileObj.user,
              text: `<a href="${fileObj.url}" target="_blank">${fileObj.filename}</a>`,
              avatar: fileObj.avatar,
              time: fileObj.time
            });
          });
          socket.on('onlineUsers', (users) => { updateOnlineUsers(users); });
          socket.on('privateMessage', (msgObj) => {
            addMessage(msgObj);
            showBrowserNotification(msgObj);
          });
        }

        socket.emit('joinGroup', { groupName: group, username });

        document.getElementById('chat').innerHTML = '';
        document.getElementById('mainChatTitle').textContent = group;
        document.getElementById('myAvatar').src = avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=random&size=64&bold=true`;
        document.getElementById('myName').textContent = username;
        document.getElementById('myEmail').textContent = window.userEmail || '';
        
        document.getElementById('joinGroupModal').classList.add('hidden');
        document.getElementById('chatBox').classList.remove('hidden');
      };

      if (avatarFile) {
        const formData = new FormData();
        formData.append('avatar', avatarFile);
        formData.append('username', username);
        fetch('http://localhost:3001/upload-avatar', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              avatarUrl = data.url;
              joinLogic();
            } else {
              showToast(LANGS[currentLang].avatarFailAlert, 'error');
            }
          });
      } else {
        joinLogic();
      }
    }

    function addMessage({ user, text, time, avatar, reply }) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-2 p-2 bg-white dark:bg-gray-700 rounded group hover:bg-blue-50 dark:hover:bg-blue-800 cursor-pointer msg-animate';
      const avatarSrc = avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=random&size=64&bold=true`;
      let replyHtml = '';
      if (reply) {
        replyHtml = `<div class='text-xs text-blue-600 dark:text-blue-300 border-l-4 border-blue-400 pl-2 mb-1'>${reply.user}: ${reply.text}</div>`;
      }
      let msgHtml = `<img src="${avatarSrc}" alt="avatar" class="w-8 h-8 rounded-full"><div>${replyHtml}<b class="text-blue-500">${user}:</b> ${text} <br><small class="text-gray-400">${time || ''}</small><div class='link-preview'></div></div>`;
      div.innerHTML = msgHtml;
      div.onclick = function() { startReply(user, text); };
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      // Link preview
      const url = extractUrl(text);
      if (url) {
        fetch('http://localhost:3001/link-preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const preview = document.createElement('div');
            preview.className = 'mt-2 p-2 border rounded bg-gray-100 dark:bg-gray-800';
            preview.innerHTML =
              (data.image ? `<img src='${data.image}' class='w-24 h-24 object-cover rounded mb-2'>` : '') +
              `<div class='font-bold'>${data.title || url}</div>` +
              (data.description ? `<div class='text-sm text-gray-600 dark:text-gray-300'>${data.description}</div>` : '') +
              `<a href='${url}' target='_blank' class='text-blue-500 underline text-xs'>${url}</a>`;
            div.querySelector('.link-preview').appendChild(preview);
          }
        });
      }
      // Remove animation class after animation ends for re-adding on next message
      div.addEventListener('animationend', () => div.classList.remove('msg-animate'));
    }

    function extractUrl(text) {
      if (!text) return null;
      const match = text.match(/https?:\/\/[\w\-\.\/?#=&%]+/);
      return match ? match[0] : null;
    }

    function startReply(user, text) {
      replyTo = { user, text };
      document.getElementById('replyBox').classList.remove('hidden');
      document.getElementById('replyPreview').textContent = `${user}: ${text}`;
    }

    function cancelReply() {
      replyTo = null;
      document.getElementById('replyBox').classList.add('hidden');
      document.getElementById('replyPreview').textContent = '';
    }

    function send() {
      const text = document.getElementById('msg').value.trim();
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!text && !file) {
        showToast('Nh·∫≠p tin nh·∫Øn ho·∫∑c ch·ªçn file!', 'error');
        return;
      }

      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('user', username);
        formData.append('group', privateChatUser ? null : group);
        formData.append('avatar', avatarUrl);
        formData.append('text', text);
        if (replyTo) formData.append('reply', JSON.stringify(replyTo));
        if (privateChatUser) formData.append('to', privateChatUser);

        fetch('http://localhost:3001/upload', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(data => {
            if (!data.success) {
              showToast(data.message || 'Upload th·∫•t b·∫°i!', 'error');
            } else {
              showToast('G·ª≠i h√¨nh ·∫£nh th√†nh c√¥ng!', 'success');
            }
          })
          .catch(err => showToast('L·ªói upload file!', 'error'));

        fileInput.value = '';
        document.getElementById('msg').value = '';
        document.getElementById('filePreview').innerHTML = '';
        cancelReply();
      } else {
        if (privateChatUser) {
          socket.emit('privateMessage', { from: username, to: privateChatUser, text, avatar: avatarUrl, reply: replyTo });
        } else {
          socket.emit('sendMessage', { user: username, text, group, avatar: avatarUrl, reply: replyTo });
        }
        document.getElementById('msg').value = '';
        cancelReply();
      }
    }

    function showResetPassword() {
      document.getElementById('authBox').classList.add('hidden');
      document.getElementById('resetBox').classList.remove('hidden');
    }

    function hideResetPassword() {
      document.getElementById('resetBox').classList.add('hidden');
      document.getElementById('authBox').classList.remove('hidden');
    }

    async function resetPassword() {
      const username = document.getElementById('resetUsername').value.trim();
      const password = document.getElementById('resetPassword').value.trim();
      if (!username || !password) { showToast('Nh·∫≠p ƒë·ªß th√¥ng tin!', 'error'); return; }
      const res = await fetch('http://localhost:3001/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      }).then(r => r.json());
      showToast(res.success ? 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!' : res.message, res.success ? 'success' : 'error');
      if (res.success) {
        document.getElementById('resetUsername').value = '';
        document.getElementById('resetPassword').value = '';
        hideResetPassword();
      }
    }

    // Settings logic
    function showSettings() {
      document.getElementById('settingsBox').classList.remove('hidden');
      document.getElementById('displayNameInput').value = username;
      document.getElementById('emailInput').value = window.userEmail || '';
      document.getElementById('themeSelect').value = document.body.classList.contains('dark') ? 'dark' : 'light';
    }
    function hideSettings() {
      document.getElementById('settingsBox').classList.add('hidden');
    }
    async function saveSettings() {
      // ƒê·ªïi t√™n hi·ªÉn th·ªã (ch·ªâ ƒë·ªïi local)
      const newName = document.getElementById('displayNameInput').value.trim();
      if (newName) username = newName;
      // ƒê·ªïi Gmail (ch·ªâ ƒë·ªïi local)
      const newEmail = document.getElementById('emailInput').value.trim();
      if (newEmail) {
        window.userEmail = newEmail;
        document.getElementById('myEmail').textContent = newEmail;
      }
      // ƒê·ªïi avatar
      const avatarFile = document.getElementById('newAvatarInput').files[0];
      if (avatarFile) {
        const formData = new FormData();
        formData.append('avatar', avatarFile);
        formData.append('username', username);
        await fetch('http://localhost:3001/upload-avatar', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => { if (data.success) avatarUrl = data.url; });
      }
      // ƒê·ªïi theme
      const theme = document.getElementById('themeSelect').value;
      if (theme === 'dark') {
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
      hideSettings();
      showToast(LANGS[currentLang].saveSuccess, 'success');
    }

    function updateOnlineUsers(users) {
      const ul = document.getElementById('onlineUsers');
      ul.innerHTML = '';
      users.forEach(u => {
        const li = document.createElement('li');
        li.className = 'flex items-center space-x-2 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-800 p-2 rounded';
        const avatar = u.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.username)}&background=random&size=32&bold=true`;
        li.innerHTML = `<img src="${avatar}" class="w-8 h-8 rounded-full"><span>${u.username}</span>`;
        li.onclick = function() { if (u.username !== username) startPrivateChat(u.username); };
        ul.appendChild(li);
      });
    }

    function startPrivateChat(user) {
      privateChatUser = user;
      document.getElementById('backToGroupBtn').classList.remove('hidden');
      document.getElementById('chat').innerHTML = '';
      document.getElementById('group').disabled = true;
      document.getElementById('msg').placeholder = `Nh·∫Øn ri√™ng t·ªõi ${user}...`;
      showToast(`ƒêang nh·∫Øn ri√™ng v·ªõi ${user}`);
    }

    function backToGroup() {
      privateChatUser = null;
      document.getElementById('backToGroupBtn').classList.add('hidden');
      document.getElementById('chat').innerHTML = '';
      document.getElementById('group').disabled = false;
      document.getElementById('msg').placeholder = 'Nh·∫≠p tin nh·∫Øn...';
      showToast('ƒê√£ quay l·∫°i chat nh√≥m');
    }

    // Toast notification
    function showToast(msg, type = 'success') {
      let toast = document.getElementById('toastBox');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toastBox';
        toast.className = 'fixed top-4 right-4 z-50 px-6 py-3 rounded shadow-lg text-white text-base font-semibold transition-all duration-300';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.backgroundColor = type === 'success' ? '#22c55e' : '#ef4444';
      toast.style.opacity = 1;
      setTimeout(() => { toast.style.opacity = 0; }, 2500);
    }

    function logout() {
      location.reload();
      document.getElementById('authModal').classList.remove('hidden');
    }

    async function changePassword() {
      const oldPass = document.getElementById('oldPasswordInput').value.trim();
      const newPass = document.getElementById('newPasswordInput').value.trim();
      const confirmPass = document.getElementById('confirmPasswordInput').value.trim();
      if (!oldPass || !newPass || !confirmPass) return showToast('Nh·∫≠p ƒë·ªß th√¥ng tin!', 'error');
      if (newPass !== confirmPass) return showToast('M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!', 'error');
      const res = await fetch('http://localhost:3001/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, oldPassword: oldPass, newPassword: newPass })
      }).then(r => r.json());
      showToast(res.success ? 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!' : res.message, res.success ? 'success' : 'error');
      if (res.success) {
        document.getElementById('oldPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
      }
    }

    // Notification API
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }
    function showBrowserNotification(msgObj) {
      if (document.hasFocus()) return; // Ch·ªâ th√¥ng b√°o khi kh√¥ng focus
      if ('Notification' in window && Notification.permission === 'granted') {
        const title = `${msgObj.user} g·ª≠i tin nh·∫Øn m·ªõi`;
        const body = msgObj.text ? msgObj.text : '[T·ªáp tin]';
        new Notification(title, { body });
      }
    }
    // G·ªçi xin quy·ªÅn khi v√†o chat
    window.addEventListener('focus', requestNotificationPermission);
    // Th√¥ng b√°o khi c√≥ tin nh·∫Øn nh√≥m
    socket && socket.on && socket.on('newMessage', (msgObj) => {
      showBrowserNotification(msgObj);
    });

    // ƒêa ng√¥n ng·ªØ
    const LANGS = {
      vi: {
        appName: 'Zashi Messaging',
        login: 'ƒêƒÉng nh·∫≠p', register: 'ƒêƒÉng k√Ω', forgot: 'Qu√™n m·∫≠t kh·∫©u?', group: 'Nh√≥m chat:',
        usernamePlaceholder: 'T√™n ƒëƒÉng nh·∫≠p', emailPlaceholder: 'Gmail', passwordPlaceholder: 'M·∫≠t kh·∫©u',
        avatar: 'Ch·ªçn ·∫£nh ƒë·∫°i di·ªán:', join: 'V√†o Chat', send: 'G·ª≠i', chooseFile: 'Ch·ªçn t·ªáp',
        placeholderMsg: 'Nh·∫≠p tin nh·∫Øn...',
        online: 'ƒêang online', settings: 'C√†i ƒë·∫∑t', logout: 'ƒêƒÉng xu·∫•t',
        displayName: 'T√™n hi·ªÉn th·ªã m·ªõi:', email: 'Gmail:', changeAvatar: 'ƒê·ªïi avatar:', theme: 'Giao di·ªán:',
        light: 'S√°ng', dark: 'T·ªëi', save: 'L∆∞u thay ƒë·ªïi', back: 'Quay l·∫°i', changePass: 'ƒê·ªïi m·∫≠t kh·∫©u:',
        oldPass: 'M·∫≠t kh·∫©u c≈©', newPass: 'M·∫≠t kh·∫©u m·ªõi', confirmPass: 'X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi',
        reply: 'ƒêang tr·∫£ l·ªùi:', cancel: 'H·ªßy', sendPrivate: 'Nh·∫Øn ri√™ng t·ªõi', backToGroup: 'Quay l·∫°i nh√≥m',
        success: 'Th√†nh c√¥ng!', error: 'L·ªói!',
        themeSwitch: 'Chuy·ªÉn giao di·ªán',
        resetTitle: 'Qu√™n m·∫≠t kh·∫©u', resetBtn: 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u', backToLogin: 'Quay l·∫°i ƒëƒÉng nh·∫≠p', newPasswordPlaceholder: 'M·∫≠t kh·∫©u m·ªõi',
        settingsTitle: 'C√†i ƒë·∫∑t', displayNamePlaceholder: 'T√™n hi·ªÉn th·ªã m·ªõi',
        joinAlert: 'Vui l√≤ng nh·∫≠p t√™n nh√≥m!', avatarFailAlert: 'T·∫£i l√™n avatar th·∫•t b·∫°i!', saveSuccess: 'ƒê√£ l∆∞u thay ƒë·ªïi!',
      },
      en: {
        appName: 'Zashi Messaging',
        login: 'Login', register: 'Register', forgot: 'Forgot password?', group: 'Group chat:',
        usernamePlaceholder: 'Username', emailPlaceholder: 'Gmail', passwordPlaceholder: 'Password',
        avatar: 'Choose avatar:', join: 'Join Chat', send: 'Send', chooseFile: 'Choose file',
        placeholderMsg: 'Type a message...',
        online: 'Online', settings: 'Settings', logout: 'Logout',
        displayName: 'Display name:', email: 'Gmail:', changeAvatar: 'Change avatar:', theme: 'Theme:',
        light: 'Light', dark: 'Dark', save: 'Save changes', back: 'Back', changePass: 'Change password:',
        oldPass: 'Old password', newPass: 'New password', confirmPass: 'Confirm new password',
        reply: 'Replying:', cancel: 'Cancel', sendPrivate: 'Private to', backToGroup: 'Back to group',
        success: 'Success!', error: 'Error!',
        themeSwitch: 'Switch theme',
        resetTitle: 'Forgot Password', resetBtn: 'Reset Password', backToLogin: 'Back to Login', newPasswordPlaceholder: 'New Password',
        settingsTitle: 'Settings', displayNamePlaceholder: 'New display name',
        joinAlert: 'Please enter a group name!', avatarFailAlert: 'Avatar upload failed!', saveSuccess: 'Changes saved!',
      },
      ja: {
        appName: 'Zashi„É°„ÉÉ„Çª„Éº„Ç∏„É≥„Ç∞',
        login: '„É≠„Ç∞„Ç§„É≥', register: 'ÁôªÈå≤', forgot: '„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„Åß„Åô„Åã?', group: '„Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà:',
        usernamePlaceholder: '„É¶„Éº„Ç∂„ÉºÂêç', emailPlaceholder: '„É°„Éº„É´', passwordPlaceholder: '„Éë„Çπ„ÉØ„Éº„Éâ',
        avatar: '„Ç¢„Éê„Çø„Éº„ÇíÈÅ∏Êäû:', join: '„ÉÅ„É£„ÉÉ„Éà„Å´ÂèÇÂä†', send: 'ÈÄÅ‰ø°', chooseFile: '„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû',
        placeholderMsg: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...',
        online: '„Ç™„É≥„É©„Ç§„É≥', settings: 'Ë®≠ÂÆö', logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
        displayName: 'Ë°®Á§∫Âêç:', email: '„É°„Éº„É´:', changeAvatar: '„Ç¢„Éê„Çø„Éº„ÇíÂ§âÊõ¥:', theme: '„ÉÜ„Éº„Éû:',
        light: '„É©„Ç§„Éà', dark: '„ÉÄ„Éº„ÇØ', save: 'Â§âÊõ¥„Çí‰øùÂ≠ò', back: 'Êàª„Çã', changePass: '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥:',
        oldPass: 'ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ', newPass: 'Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ', confirmPass: 'Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç',
        reply: 'Ëøî‰ø°‰∏≠:', cancel: '„Ç≠„É£„É≥„Çª„É´', sendPrivate: '„Éó„É©„Ç§„Éô„Éº„Éà:', backToGroup: '„Ç∞„É´„Éº„Éó„Å´Êàª„Çã',
        success: 'ÊàêÂäü!', error: '„Ç®„É©„Éº!',
        themeSwitch: '„ÉÜ„Éº„ÉûÂàáÊõø',
        resetTitle: '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„Åæ„Åó„Åü', resetBtn: '„Éë„Çπ„ÉØ„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà', backToLogin: '„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã', newPasswordPlaceholder: 'Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ',
        settingsTitle: 'Ë®≠ÂÆö', displayNamePlaceholder: 'Êñ∞„Åó„ÅÑË°®Á§∫Âêç',
        joinAlert: '„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ', avatarFailAlert: '„Ç¢„Éê„Çø„Éº„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºÅ', saveSuccess: 'Â§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
      },
      zh: {
        appName: 'ZashiÊ∂àÊÅØ',
        login: 'ÁôªÂΩï', register: 'Ê≥®ÂÜå', forgot: 'ÂøòËÆ∞ÂØÜÁ†ÅÔºü', group: 'Áæ§ËÅä:',
        usernamePlaceholder: 'Áî®Êà∑Âêç', emailPlaceholder: 'ÈÇÆÁÆ±', passwordPlaceholder: 'ÂØÜÁ†Å',
        avatar: 'ÈÄâÊã©Â§¥ÂÉè:', join: 'Âä†ÂÖ•ËÅäÂ§©', send: 'ÂèëÈÄÅ', chooseFile: 'ÈÄâÊã©Êñá‰ª∂',
        placeholderMsg: 'ËæìÂÖ•Ê∂àÊÅØ...',
        online: 'Âú®Á∫ø', settings: 'ËÆæÁΩÆ', logout: 'ÁôªÂá∫',
        displayName: 'ÊòæÁ§∫ÂêçÁß∞:', email: 'ÈÇÆÁÆ±:', changeAvatar: 'Êõ¥Êç¢Â§¥ÂÉè:', theme: '‰∏ªÈ¢ò:',
        light: 'ÊµÖËâ≤', dark: 'Ê∑±Ëâ≤', save: '‰øùÂ≠òÊõ¥Êîπ', back: 'ËøîÂõû', changePass: 'Êõ¥ÊîπÂØÜÁ†Å:',
        oldPass: 'ÊóßÂØÜÁ†Å', newPass: 'Êñ∞ÂØÜÁ†Å', confirmPass: 'Á°ÆËÆ§Êñ∞ÂØÜÁ†Å',
        reply: 'ÂõûÂ§ç:', cancel: 'ÂèñÊ∂à', sendPrivate: 'ÁßÅ‰ø°Áªô', backToGroup: 'ËøîÂõûÁæ§ÁªÑ',
        success: 'ÊàêÂäüÔºÅ', error: 'ÈîôËØØÔºÅ',
        themeSwitch: 'ÂàáÊç¢‰∏ªÈ¢ò',
        resetTitle: 'ÂøòËÆ∞ÂØÜÁ†Å', resetBtn: 'ÈáçËÆæÂØÜÁ†Å', backToLogin: 'ËøîÂõûÁôªÂΩï', newPasswordPlaceholder: 'Êñ∞ÂØÜÁ†Å',
        settingsTitle: 'ËÆæÁΩÆ', displayNamePlaceholder: 'Êñ∞ÁöÑÊòæÁ§∫ÂêçÁß∞',
        joinAlert: 'ËØ∑ËæìÂÖ•Áæ§ÁªÑÂêçÁß∞ÔºÅ', avatarFailAlert: 'Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•ÔºÅ', saveSuccess: 'Êõ¥ÊîπÂ∑≤‰øùÂ≠òÔºÅ',
      },
      th: {
        appName: 'Zashi ‡πÄ‡∏°‡∏™‡πÄ‡∏ã‡∏à‡∏à‡∏¥‡πâ‡∏á',
        login: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', register: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', forgot: '‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?', group: '‡πÅ‡∏ä‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°:',
        usernamePlaceholder: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', emailPlaceholder: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', passwordPlaceholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
        avatar: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ß‡∏ï‡∏≤‡∏£:', join: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ä‡∏ó', send: '‡∏™‡πà‡∏á', chooseFile: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå',
        placeholderMsg: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...',
        online: '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', settings: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', logout: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        displayName: '‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á:', email: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•:', changeAvatar: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏ß‡∏ï‡∏≤‡∏£:', theme: '‡∏ò‡∏µ‡∏°:',
        light: '‡∏™‡∏ß‡πà‡∏≤‡∏á', dark: '‡∏°‡∏∑‡∏î', save: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', back: '‡∏Å‡∏•‡∏±‡∏ö', changePass: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:',
        oldPass: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤', newPass: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', confirmPass: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
        reply: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:', cancel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', sendPrivate: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ñ‡∏∂‡∏á', backToGroup: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°',
        success: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', error: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
        themeSwitch: '‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°',
        resetTitle: '‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', resetBtn: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', backToLogin: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', newPasswordPlaceholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
        settingsTitle: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', displayNamePlaceholder: '‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà',
        joinAlert: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°!', avatarFailAlert: '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!', saveSuccess: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
      },
      tl: {
        appName: 'Zashi Messaging',
        login: 'Mag-login', register: 'Magrehistro', forgot: 'Nakalimutan ang password?', group: 'Group chat:',
        usernamePlaceholder: 'Username', emailPlaceholder: 'Email', passwordPlaceholder: 'Password',
        avatar: 'Pumili ng avatar:', join: 'Sumali sa Chat', send: 'Ipadala', chooseFile: 'Pumili ng file',
        placeholderMsg: 'Mag-type ng mensahe...',
        online: 'Online', settings: 'Mga Setting', logout: 'Mag-logout',
        displayName: 'Display name:', email: 'Email:', changeAvatar: 'Palitan ang avatar:', theme: 'Tema:',
        light: 'Maliwanag', dark: 'Madilim', save: 'I-save ang mga pagbabago', back: 'Bumalik', changePass: 'Palitan ang password:',
        oldPass: 'Lumang password', newPass: 'Bagong password', confirmPass: 'Kumpirmahin ang bagong password',
        reply: 'Sumasagot sa:', cancel: 'Kanselahin', sendPrivate: 'Pribado para kay', backToGroup: 'Bumalik sa grupo',
        success: 'Tagumpay!', error: 'Error!',
        themeSwitch: 'Palitan ang tema',
        resetTitle: 'Nakalimutan ang Password', resetBtn: 'I-reset ang Password', backToLogin: 'Bumalik sa Pag-login', newPasswordPlaceholder: 'Bagong Password',
        settingsTitle: 'Mga Setting', displayNamePlaceholder: 'Bagong display name',
        joinAlert: 'Pakilagay ang pangalan ng grupo!', avatarFailAlert: 'Nabigo ang pag-upload ng avatar!', saveSuccess: 'Nai-save ang mga pagbabago!',
      },
      es: {
        appName: 'Mensajer√≠a Zashi',
        login: 'Iniciar sesi√≥n', register: 'Registrarse', forgot: '¬øOlvidaste tu contrase√±a?', group: 'Chat grupal:',
        usernamePlaceholder: 'Usuario', emailPlaceholder: 'Correo', passwordPlaceholder: 'Contrase√±a',
        avatar: 'Elegir avatar:', join: 'Unirse al Chat', send: 'Enviar', chooseFile: 'Elegir archivo',
        placeholderMsg: 'Escribe un mensaje...',
        online: 'En l√≠nea', settings: 'Ajustes', logout: 'Cerrar sesi√≥n',
        displayName: 'Nombre de usuario:', email: 'Correo:', changeAvatar: 'Cambiar avatar:', theme: 'Tema:',
        light: 'Claro', dark: 'Oscuro', save: 'Guardar cambios', back: 'Volver', changePass: 'Cambiar contrase√±a:',
        oldPass: 'Contrase√±a anterior', newPass: 'Contrase√±a nueva', confirmPass: 'Confirmar contrase√±a nueva',
        reply: 'Respondiendo a:', cancel: 'Cancelar', sendPrivate: 'Privado para', backToGroup: 'Volver al grupo',
        success: '¬°√âxito!', error: '¬°Error!',
        themeSwitch: 'Cambiar tema',
        resetTitle: '¬øOlvidaste tu contrase√±a?', resetBtn: 'Restablecer contrase√±a', backToLogin: 'Volver a Iniciar sesi√≥n', newPasswordPlaceholder: 'Nueva contrase√±a',
        settingsTitle: 'Ajustes', displayNamePlaceholder: 'Nuevo nombre de usuario',
        joinAlert: '¬°Por favor, introduce un nombre de grupo!', avatarFailAlert: '¬°Fall√≥ la subida del avatar!', saveSuccess: '¬°Cambios guardados!',
      },
      ru: {
        appName: 'Zashi –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä',
        login: '–í–æ–π—Ç–∏', register: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è', forgot: '–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?', group: '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç:',
        usernamePlaceholder: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', emailPlaceholder: '–≠–ª. –ø–æ—á—Ç–∞', passwordPlaceholder: '–ü–∞—Ä–æ–ª—å',
        avatar: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:', join: '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è', send: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å', chooseFile: '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª',
        placeholderMsg: '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
        online: '–í —Å–µ—Ç–∏', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', logout: '–í—ã–π—Ç–∏',
        displayName: '–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:', email: '–≠–ª. –ø–æ—á—Ç–∞:', changeAvatar: '–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä:', theme: '–¢–µ–º–∞:',
        light: '–°–≤–µ—Ç–ª–∞—è', dark: '–¢–µ–º–Ω–∞—è', save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è', back: '–ù–∞–∑–∞–¥', changePass: '–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å:',
        oldPass: '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å', newPass: '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å', confirmPass: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å',
        reply: '–û—Ç–≤–µ—Ç:', cancel: '–û—Ç–º–µ–Ω–∞', sendPrivate: '–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è', backToGroup: '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É',
        success: '–£—Å–ø–µ—Ö!', error: '–û—à–∏–±–∫–∞!',
        themeSwitch: '–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É',
        resetTitle: '–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å', resetBtn: '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å', backToLogin: '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É', newPasswordPlaceholder: '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å',
        settingsTitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', displayNamePlaceholder: '–ù–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è',
        joinAlert: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã!', avatarFailAlert: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞!', saveSuccess: '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!',
      },
      ms: {
        appName: 'Pemesejan Zashi',
        login: 'Log masuk', register: 'Daftar', forgot: 'Lupa kata laluan?', group: 'Sembang kumpulan:',
        usernamePlaceholder: 'Nama pengguna', emailPlaceholder: 'E-mel', passwordPlaceholder: 'Kata laluan',
        avatar: 'Pilih avatar:', join: 'Sertai Sembang', send: 'Hantar', chooseFile: 'Pilih fail',
        placeholderMsg: 'Taip mesej...',
        online: 'Dalam talian', settings: 'Tetapan', logout: 'Log keluar',
        displayName: 'Nama paparan:', email: 'E-mel:', changeAvatar: 'Tukar avatar:', theme: 'Tema:',
        light: 'Cerah', dark: 'Gelap', save: 'Simpan perubahan', back: 'Kembali', changePass: 'Tukar kata laluan:',
        oldPass: 'Kata laluan lama', newPass: 'Kata laluan baharu', confirmPass: 'Sahkan kata laluan baharu',
        reply: 'Membalas kepada:', cancel: 'Batal', sendPrivate: 'Peribadi kepada', backToGroup: 'Kembali ke kumpulan',
        success: 'Berjaya!', error: 'Ralat!',
        themeSwitch: 'Tukar tema',
        resetTitle: 'Lupa Kata Laluan', resetBtn: 'Set semula Kata Laluan', backToLogin: 'Kembali ke Log Masuk', newPasswordPlaceholder: 'Kata laluan baharu',
        settingsTitle: 'Tetapan', displayNamePlaceholder: 'Nama paparan baharu',
        joinAlert: 'Sila masukkan nama kumpulan!', avatarFailAlert: 'Muat naik avatar gagal!', saveSuccess: 'Perubahan disimpan!',
      },
      ko: {
        appName: 'Zashi Î©îÏãúÏßï',
        login: 'Î°úÍ∑∏Ïù∏', register: 'ÌöåÏõêÍ∞ÄÏûÖ', forgot: 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏúºÏÖ®ÎÇòÏöî?', group: 'Í∑∏Î£π Ï±ÑÌåÖ:',
        usernamePlaceholder: 'ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ', emailPlaceholder: 'Ïù¥Î©îÏùº', passwordPlaceholder: 'ÎπÑÎ∞ÄÎ≤àÌò∏',
        avatar: 'ÏïÑÎ∞îÌÉÄ ÏÑ†ÌÉù:', join: 'Ï±ÑÌåÖ Ï∞∏Ïó¨', send: 'Ï†ÑÏÜ°', chooseFile: 'ÌååÏùº ÏÑ†ÌÉù',
        placeholderMsg: 'Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...',
        online: 'Ïò®ÎùºÏù∏', settings: 'ÏÑ§Ï†ï', logout: 'Î°úÍ∑∏ÏïÑÏõÉ',
        displayName: 'ÌëúÏãú Ïù¥Î¶Ñ:', email: 'Ïù¥Î©îÏùº:', changeAvatar: 'ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω:', theme: 'ÌÖåÎßà:',
        light: 'ÎùºÏù¥Ìä∏', dark: 'Îã§ÌÅ¨', save: 'Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•', back: 'Îí§Î°ú', changePass: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω:',
        oldPass: 'Í∏∞Ï°¥ ÎπÑÎ∞ÄÎ≤àÌò∏', newPass: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏', confirmPass: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏',
        reply: 'ÎãµÏû• Ï§ë:', cancel: 'Ï∑®ÏÜå', sendPrivate: 'ÎãòÏóêÍ≤å Í∞úÏù∏ Î©îÏãúÏßÄ', backToGroup: 'Í∑∏Î£πÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞',
        success: 'ÏÑ±Í≥µ!', error: 'Ïò§Î•ò!',
        themeSwitch: 'ÌÖåÎßà Ï†ÑÌôò',
        resetTitle: 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏúºÏÖ®ÎÇòÏöî', resetBtn: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï', backToLogin: 'Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞', newPasswordPlaceholder: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏',
        settingsTitle: 'ÏÑ§Ï†ï', displayNamePlaceholder: 'ÏÉà ÌëúÏãú Ïù¥Î¶Ñ',
        joinAlert: 'Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!', avatarFailAlert: 'ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú Ïã§Ìå®!', saveSuccess: 'Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!',
      }
    };
    let currentLang = localStorage.getItem('lang') || 'vi';
    function switchLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      renderLang();
    }
    function renderLang() {
      const t = LANGS[currentLang];
      const el = (id) => document.getElementById(id);
      document.getElementById('langSwitch').value = currentLang;

      // App title
      if(el('mainTitle')) el('mainTitle').innerText = t.appName;

      // Auth
      if (el('loginBtn')) el('loginBtn').innerText = t.login;
      if (el('registerBtn')) el('registerBtn').innerText = t.register;
      if (el('forgotBtn')) el('forgotBtn').innerText = t.forgot;
      if (el('username')) el('username').setAttribute('placeholder', t.usernamePlaceholder);
      if (el('email')) el('email').setAttribute('placeholder', t.emailPlaceholder);
      if (el('password')) el('password').setAttribute('placeholder', t.passwordPlaceholder);
      
      // Reset Password
      if (el('resetTitle')) el('resetTitle').innerText = t.resetTitle;
      if (el('resetUsername')) el('resetUsername').setAttribute('placeholder', t.usernamePlaceholder);
      if (el('resetPassword')) el('resetPassword').setAttribute('placeholder', t.newPasswordPlaceholder);
      if (el('resetBtn')) el('resetBtn').innerText = t.resetBtn;
      if (el('backToLoginBtn')) el('backToLoginBtn').innerText = t.backToLogin;

      // Chat
      const groupLabel = document.querySelector('label[for="group"]');
      if (groupLabel) groupLabel.innerText = t.group;
      if (el('group')) el('group').setAttribute('placeholder', t.group);
      const avatarLabel = document.querySelector('label[for="avatarInput"]');
      if (avatarLabel) avatarLabel.innerText = t.avatar;
      if (el('joinBtn')) el('joinBtn').innerText = t.join;
      if (el('msg')) el('msg').setAttribute('placeholder', t.placeholderMsg);
      if (el('chooseFileLabel')) el('chooseFileLabel').innerText = t.chooseFile;
      const sendBtn = el('sendBtn');
      if (sendBtn && sendBtn.querySelector('span')) sendBtn.querySelector('span').innerText = t.send;
      const onlineLabel = document.querySelector('h3.font-semibold');
      if (onlineLabel) onlineLabel.innerText = t.online;
      if (el('settingsBtn')) el('settingsBtn').innerText = t.settings;
      if (el('logoutBtn')) el('logoutBtn').innerText = t.logout;

      // Settings
      if (el('settingsTitle')) el('settingsTitle').innerText = t.settingsTitle;
      const displayNameLabel = document.querySelector('label[for="displayNameInput"]');
      if (displayNameLabel) displayNameLabel.innerText = t.displayName;
      if (el('displayNameInput')) el('displayNameInput').setAttribute('placeholder', t.displayNamePlaceholder);
      const emailLabel = document.querySelector('label[for="emailInput"]');
      if (emailLabel) emailLabel.innerText = t.email;
      if (el('emailInput')) el('emailInput').setAttribute('placeholder', t.emailPlaceholder);
      const avatarChangeLabel = document.querySelector('label[for="newAvatarInput"]');
      if (avatarChangeLabel) avatarChangeLabel.innerText = t.changeAvatar;
      const themeLabel = document.querySelector('label[for="themeSelect"]');
      if (themeLabel) themeLabel.innerText = t.theme;
      const lightOpt = document.querySelector('option[value="light"]');
      if (lightOpt) lightOpt.innerText = t.light;
      const darkOpt = document.querySelector('option[value="dark"]');
      if (darkOpt) darkOpt.innerText = t.dark;
      if (el('saveSettingsBtn')) el('saveSettingsBtn').innerText = t.save;
      if (el('hideSettingsBtn')) el('hideSettingsBtn').innerText = t.back;
      const oldPassLabel = document.querySelector('label[for="oldPasswordInput"]');
      if (oldPassLabel) oldPassLabel.innerText = t.changePass;
      if (el('oldPasswordInput')) el('oldPasswordInput').setAttribute('placeholder', t.oldPass);
      if (el('newPasswordInput')) el('newPasswordInput').setAttribute('placeholder', t.newPass);
      if (el('confirmPasswordInput')) el('confirmPasswordInput').setAttribute('placeholder', t.confirmPass);
      const replyBox = el('replyBox');
      if (replyBox && replyBox.querySelector('span.font-semibold')) replyBox.querySelector('span.font-semibold').innerText = t.reply;
      if (replyBox && replyBox.querySelector('button')) replyBox.querySelector('button').innerText = t.cancel;
      if (el('msg')) el('msg').setAttribute('placeholder', privateChatUser ? `${t.sendPrivate} ${privateChatUser}...` : t.placeholderMsg);
      if (el('backToGroupBtn')) el('backToGroupBtn').innerText = t.backToGroup;
      if (el('changePassBtn')) el('changePassBtn').innerText = t.changePass;
      // Theme toggle
      if (el('themeToggle')) el('themeToggle').title = t.themeSwitch;
    }
    document.addEventListener('DOMContentLoaded', renderLang);

    // ƒê·∫∑t ƒëo·∫°n n√†y ·ªü cu·ªëi script, sau t·∫•t c·∫£ c√°c khai b√°o h√†m
    window.login = login;
    window.register = register;
    window.showResetPassword = showResetPassword;
    window.hideResetPassword = hideResetPassword;
    window.resetPassword = resetPassword;
    window.showSettings = showSettings;
    window.hideSettings = hideSettings;
    window.saveSettings = saveSettings;
    window.changePassword = changePassword;
    window.logout = logout;
    window.send = send;
    window.switchLanguage = switchLanguage;
    window.startReply = startReply;
    window.cancelReply = cancelReply;
    window.startPrivateChat = startPrivateChat;
    window.backToGroup = backToGroup;
    window.showJoinGroupModal = showJoinGroupModal;

    // Dark mode logic
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
      } else {
        document.body.classList.remove('dark');
        document.getElementById('themeIcon').textContent = 'üåô';
      }
      localStorage.setItem('theme', theme);
    }
    function toggleTheme() {
      const isDark = document.body.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }
    // Auto detect OS theme on first load
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) setTheme(saved);
      else if (window.matchMedia('(prefers-color-scheme: dark)').matches) setTheme('dark');
      else setTheme('light');
    })();
  </script>
</body>
</html>
